#' Chat with any provider
#'
#' This is a generic interface to all the other `chat_` functions that allow
#' to you pick the provider and the model with a simple string.
#'
#' @inheritParams chat_openai
#' @param name Provider (and optionally model) name in the form
#'   `"provider/model"` or `"provider"` (which will use the default model
#'   for that provider).
#' @param ... Arguments passed to the provider function.
#' @rdname chat-any
#' @export
chat <- function(
  name,
  ...,
  system_prompt = NULL,
  params = NULL,
  echo = c("none", "output", "all")
) {
  check_string(name, allow_empty = FALSE)
  pieces <- strsplit(name, "/", fixed = TRUE)[[1]]

  provider <- model <- NULL

  if (length(pieces) == 1) {
    provider <- pieces[[1]]
  } else if (length(pieces) >= 2) {
    provider <- pieces[[1]]
    if (length(pieces) == 2) {
      model <- pieces[[2]]
    } else if (provider == "github") {
      # GitHub model names use the `provider/model` format
      model <- paste(pieces[-1], collapse = "/")
    } else {
      # invalid format
      provider <- NULL
    }
  }

  if (is.null(provider)) {
    cli::cli_abort(
      "{.arg name} must be in form {.str provider} or {.str provider/model}."
    )
  }

  provider_fn_name <- paste0("chat_", provider)
  chat_fun <- env_get(asNamespace("ellmer"), provider_fn_name, default = NULL)
  if (is.null(chat_fun)) {
    cli::cli_abort("Can't find provider {.code ellmer::{provider_fn_name}()}.")
  }

  chat_fun(
    model = model,
    ...,
    system_prompt = system_prompt,
    params = params,
    echo = echo
  )
}
